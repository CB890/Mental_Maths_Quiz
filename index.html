<h2>Choose your character:</h2>
    <div class="character-selection">
        <div class="character" data-character="robot">
            <svg viewBox="0 0 24 24" fill="white">
                <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z" />
            </svg>
            <span class="character-name">Robot</span>
        </div>
        <div class="character" data-character="astronaut">
            <svg viewBox="0 0 24 24" fill="white">
                <path d="M21,9V8C21,6.34 19.66,5 18,5H15V4C15,2.9 14.1,2 13,2H11C9.9,2 9,2.9 9,4V5H6C4.34,5 3,6.34 3,8V9C3,9.55 3.45,10 4,10H5V11H4C3.45,11 3,11.45 3,12V14C3,14.55 3.45,15 4,15H5V16H4C3.45,16 3,16.45 3,17V19C3,20.66 4.34,22 6,22H18C19.66,22 21,20.66 21,19V17C21,16.45 20.55,16 20,16H19V15H20C20.55,15 21,14.55 21,14V12C21,11.45 20.55,11 20,11H19V10H20C20.55,10 21,9.55 21,9M15,7H18C18.55,7 19,7.45 19,8H15V7M14,4H10V5H14V4M13,15L12,13L11,15H13M9,15.93V19H6C5.45,19 5,18.55 5,18V17H7V16H5V15H7V14H5V13H7V12H5V11H7V10H5V9H9V15.93M17,19H11V16H13C13.55,16 14,15.55 14,15C14,14.45 13.55,14 13,14H11V9H17V19Z" />
            </svg>
            <span class="character-name">Astronaut</span>
        </div>
        <div class="character" data-character="scientist">
            <svg viewBox="0 0 24 24" fill="white">
                <path d="M5,19A1,1 0 0,0 6,20H18A1,1 0 0,0 19,19C19,18.79 18.93,18.59 18.82,18.43L13,8.35V4H11V8.35L5.18,18.43C5.07,18.59 5,18.79 5,19M6,22A3,3 0 0,1 3,19C3,18.4 3.18,17.84 3.5,17.37L9,7.81V6A1,1 0 0,1 8,5V4A2,2 0 0,1 10,2H14A2,2 0 0,1 16,4V5A1,1 0 0,1 15,6V7.81L20.5,17.37C20.82,17.84 21,18.4 21,19A3,3 0 0,1 18,22H6M13,16L14.34,14.66L16.27,18H7.73L10.34,13.27L13,16M12.5,13A0.5,0.5 0 0,1 13,12.5A0.5,0.5 0 0,1 13.5,13A0.5,0.5 0 0,1 13,13.5A0.5,0.5 0 0,1 12.5,13Z" />
            </svg>
            <span class="character-name">Scientist</span>
        </div>
        <div class="character" data-character="athlete">
            <svg viewBox="0 0 24 24" fill="white">
                <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M15.9,8.1C15.5,7.7 14.8,7 13.5,7H10.5C9.2,7 8.5,7.7 8.1,8.1C7.7,8.5 7.5,9 7.5,9.5V14.2L9,15V20L12,21L15,20V15L16.5,14.2V9.5C16.5,9 16.3,8.5 15.9,8.1M12,11C11.4,11 11,10.6 11,10C11,9.4 11.4,9 12,9C12.6,9 13,9.4 13,10C13,10.6 12.6,11 12,11Z" />
            </svg>
            <span class="character-name">Athlete</span>
        </div>
    </div>
    
    <button class="start-btn" id="startBtn" disabled>Start Quiz</button>
</div>

<!-- Quiz Screen -->
<div class="container quiz-screen" id="quizScreen">
    <div class="header">
        <div class="selected-character" id="selectedCharacter">
            <!-- Character icon will be shown here -->
        </div>
        <div class="score-container">
            <span>Score</span>
            <span class="score" id="score">0</span>
        </div>
    </div>
    
    <div class="progress-bar">
        <div class="progress" id="progress"></div>
    </div>
    
    <h2>Question <span id="currentQuestion">1</span> of 8</h2>
    
    <div class="question-container">
        <div class="question" id="question"></div>
    </div>
    
    <!-- Listen Again option removed as requested -->
    
    <div class="timer-container">
        Time remaining: <span class="timer" id="timer">10</span> seconds
    </div>
    
    <div class="answer-container">
        <input type="text" class="answer-input" id="answerInput" disabled>
    </div>
    
    <button class="submit-btn" id="submitBtn" disabled>Submit Answer</button>
</div>

<!-- Results Screen -->
<div class="container results-screen" id="resultsScreen">
    <h1 class="results-title">Quiz Complete!</h1>
    <div class="results-message" id="resultsMessage"></div>
    
    <div class="results-list" id="resultsList">
        <!-- Results will be shown here -->
    </div>
    
    <button class="restart-btn" id="restartBtn">Play Again</button>
</div>

<script>
    // Quiz Questions and Answers
    const questions = [
        { question: "What is 15 plus 7?", answer: "22" },
        { question: "What is half of 36?", answer: "18" },
        { question: "What is 7 times 6?", answer: "42" },
        { question: "What is 100 minus 45?", answer: "55" },
        { question: "What is double 23?", answer: "46" },
        { question: "What is 56 divided by 8?", answer: "7" },
        { question: "What is 3 more than 29?", answer: "32" },
        { question: "What is 1 less than 50?", answer: "49" }
    ];
    
    // DOM Elements
    const welcomeScreen = document.getElementById('welcomeScreen');
    const quizScreen = document.getElementById('quizScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const restartBtn = document.getElementById('restartBtn');
    const characters = document.querySelectorAll('.character');
    const selectedCharacterDiv = document.getElementById('selectedCharacter');
    const questionElement = document.getElementById('question');
    const currentQuestionElement = document.getElementById('currentQuestion');
    const progressBar = document.getElementById('progress');
    const answerInput = document.getElementById('answerInput');
    const timerElement = document.getElementById('timer');
    const scoreElement = document.getElementById('score');
    const resultsMessage = document.getElementById('resultsMessage');
    const resultsList = document.getElementById('resultsList');
    
    // Quiz State
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval;
    let secondsLeft = 10;
    let selectedCharacter = null;
    let speechSynthesis = window.speechSynthesis;
    let speechUtterance = new SpeechSynthesisUtterance();
    let readings = 0;
    let answers = [];
    let isSpeaking = false;
    let isTimerRunning = false;
    
    // Initialize
    function init() {
        // Character Selection
        characters.forEach(character => {
            character.addEventListener('click', () => {
                characters.forEach(c => c.classList.remove('selected'));
                character.classList.add('selected');
                selectedCharacter = character.getAttribute('data-character');
                selectedCharacterDiv.innerHTML = character.innerHTML;
                startBtn.disabled = false;
            });
        });
        
        // Configure Speech Synthesis
        setupSpeech();
        
        // Event Listeners
        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', submitAnswer);
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });
        restartBtn.addEventListener('click', resetQuiz);
    }
    
    // Set up speech synthesis
    function setupSpeech() {
        speechUtterance.rate = 0.9;
        speechUtterance.pitch = 1;
        
        // Force voice loading
        speechSynthesis.getVoices();
        
        // If voices aren't loaded, wait for them
        if (speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = function() {
                selectBritishFemaleVoice(speechSynthesis.getVoices());
            };
        } else {
            selectBritishFemaleVoice(speechSynthesis.getVoices());
        }
        
        // Fix for Chrome's bug where speech synthesis stops after 15 seconds
        window.setInterval(function() {
            if (speechSynthesis.speaking) {
                speechSynthesis.pause();
                speechSynthesis.resume();
            }
        }, 10000);
    }
    
    // Select British female voice if available
    function selectBritishFemaleVoice(voices) {
        // Preferred voices in order
        const preferredVoices = [
            'Google UK English Female',
            'en-GB-female',
            'en-GB',
            'English United Kingdom'
        ];
        
        // Try to find a preferred voice
        let selectedVoice = null;
        
        for (const preferred of preferredVoices) {
            const foundVoice = voices.find(voice => 
                voice.name.includes(preferred) || 
                voice.lang.includes(preferred)
            );
            
            if (foundVoice) {
                selectedVoice = foundVoice;
                break;
            }
        }
        
        // If no preferred voice found, try to find any English voice
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.startsWith('en')
            );
        }
        
        // If still no voice, use the default
        if (selectedVoice) {
            speechUtterance.voice = selectedVoice;
        }
    }
    
    // Start the Quiz
    function startQuiz() {
        welcomeScreen.style.display = 'none';
        quizScreen.style.display = 'block';
        
        // Make sure speech synthesis is ready
        if (typeof speechSynthesis !== 'undefined') {
            speechSynthesis.cancel(); // Clear any pending speech
            
            // Force the browser to load voices
            speechSynthesis.getVoices();
            
            setTimeout(() => {
                // A small delay to ensure everything is ready
                loadQuestion();
            }, 500);
        } else {
            // Fallback if speech synthesis is not available
            alert("Text-to-speech is not supported in your browser. Questions will not be read aloud.");
            loadQuestion();
        }
    }
    
    // Load a question
    function loadQuestion() {
        if (currentQuestionIndex >= questions.length) {
            showResults();
            return;
        }
        
        // Reset state for new question
        secondsLeft = 10;
        readings = 0;
        isSpeaking = false;
        isTimerRunning = false;
        
        // Update UI
        answerInput.value = '';
        answerInput.disabled = true;
        submitBtn.disabled = true;
        timerElement.textContent = secondsLeft;
        currentQuestionElement.textContent = currentQuestionIndex + 1;
        progressBar.style.width = `${(currentQuestionIndex / questions.length) * 100}%`;
        
        // Set question text
        const currentQuestion = questions[currentQuestionIndex];
        questionElement.textContent = currentQuestion.question;
        
        // Read question aloud twice before starting timer
        readQuestionAloud();
    }
    
    // Read the question aloud
    function readQuestionAloud() {
        isSpeaking = true;
        replayBtn.disabled = true;
        
        // Cancel any ongoing speech
        speechSynthesis.cancel();
        
        // Set the question text
        speechUtterance.text = questions[currentQuestionIndex].question;
        
        // First reading
        speechSynthesis.speak(speechUtterance);
        
        // After first reading completes
        speechUtterance.onend = function() {
            readings++;
            
            if (readings === 1) {
                // Short pause between readings
                setTimeout(() => {
                    // Second reading
                    speechSynthesis.speak(speechUtterance);
                }, 1000);
            } else if (readings === 2) {
                // After second reading, start timer and enable input
                isSpeaking = false;
                startTimer();
                answerInput.disabled = false;
                answerInput.focus();
                submitBtn.disabled = false;
            }
        };
    }
    
    // Replay the question audio (limited to 2 additional plays)
    function replayQuestion() {
        if (playsLeft > 0 && !isSpeaking && !isTimerRunning) {
            playsLeft--;
            playsLeftElement.textContent = `${playsLeft} plays left`;
            
            if (playsLeft === 0) {
                replayBtn.disabled = true;
            }
            
            // Reset readings counter for this replay
            readings = 0;
            readQuestionAloud();
        }
    }
    
    // Start the timer
    function startTimer() {
        isTimerRunning = true;
        timerInterval = setInterval(() => {
            secondsLeft--;
            timerElement.textContent = secondsLeft;
            
            if (secondsLeft <= 0) {
                clearInterval(timerInterval);
                timeUp();
            }
        }, 1000);
    }
    
    // Time's up - move to next question
    function timeUp() {
        isTimerRunning = false;
        
        // Record the answer (or lack thereof)
        const currentQuestion = questions[currentQuestionIndex];
        answers.push({
            question: currentQuestion.question,
            correctAnswer: currentQuestion.answer,
            userAnswer: answerInput.value,
            correct: answerInput.value === currentQuestion.answer
        });
        
        // Move to next question
        currentQuestionIndex++;
        loadQuestion();
    }
    
    // Submit answer
    function submitAnswer() {
        if (answerInput.disabled || isSpeaking) return;
        
        clearInterval(timerInterval);
        isTimerRunning = false;
        
        const currentQuestion = questions[currentQuestionIndex];
        const userAnswer = answerInput.value.trim();
        const isCorrect = userAnswer === currentQuestion.answer;
        
        // Record answer
        answers.push({
            question: currentQuestion.question,
            correctAnswer: currentQuestion.answer,
            userAnswer: userAnswer,
            correct: isCorrect
        });
        
        // Update score
        if (isCorrect) {
            score++;
            scoreElement.textContent = score;
        }
        
        // Move to next question
        currentQuestionIndex++;
        loadQuestion();
    }
    
    // Show results
    function showResults() {
        quizScreen.style.display = 'none';
        resultsScreen.style.display = 'block';
        
        // Calculate percentage
        const percentage = Math.round((score / questions.length) * 100);
        
        // Display appropriate message based on score
        let message;
        if (percentage >= 90) {
            message = "Amazing work! You're a maths superstar!";
        } else if (percentage >= 70) {
            message = "Great job! You're really good at mental maths!";
        } else if (percentage >= 50) {
            message = "Well done! You're making good progress with your mental maths!";
        } else {
            message = "Good try! Keep practising your mental maths skills!";
        }
        
        resultsMessage.textContent = `You scored ${score} out of ${questions.length} (${percentage}%). ${message}`;
        
        // Display results list
        resultsList.innerHTML = '';
        answers.forEach((answer, index) => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            
            resultItem.innerHTML = `
                <span class="result-question">${index + 1}. ${answer.question}</span>
                <span class="result-answer">Your answer: ${answer.userAnswer || '(no answer)'}</span>
                <span class="result-answer">Correct answer: ${answer.correctAnswer}</span>
                <span class="result-icon ${answer.correct ? 'result-correct' : 'result-incorrect'}">
                    ${answer.correct ? '✓' : '✗'}
                </span>
            `;
            
            resultsList.appendChild(resultItem);
        });
    }
    
    // Reset Quiz
    function resetQuiz() {
        // Reset all state variables
        currentQuestionIndex = 0;
        score = 0;
        answers = [];
        
        // Reset UI
        scoreElement.textContent = score;
        
        // Show welcome screen
        resultsScreen.style.display = 'none';
        welcomeScreen.style.display = 'flex';
    }
    
    // Initialize the quiz
    document.addEventListener('DOMContentLoaded', init);
</script>
